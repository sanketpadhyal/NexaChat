<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="assets/favicon2.png"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexaChat - Chat Room</title>
    <link rel="stylesheet" href="style.css">
</head>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Montserrat', sans-serif;
    color: white;
    background: black url('assets/bg.jpg') no-repeat center center/cover;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

.chat-container {
    width: 95%;
    max-width: 700px;
    height: 90vh;                
    display: flex;
    flex-direction: column;
    padding: 20px;
    margin: auto;

    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    flex-wrap: wrap;
    gap: 10px;
}
.chat-header h2 { font-size: 1.2rem; }

#leaveChat {
    background: rgba(255, 0, 0, 0.56);
    border: none;
    color: white;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 0.9rem;
}
#leaveChat:hover { background: rgba(255, 0, 0, 0.871); }

.messages {
    flex: 1;                     
    overflow-y: auto;
    padding: 10px;
    margin: 10px 0;
    box-sizing: border-box;
}

/* Message */
.message {
    margin-bottom: 10px;
    padding: 8px 12px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    word-wrap: break-word;
    font-size: 0.95rem;
}

/* Input Area */
.message-input {
    display: flex;
    gap: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.2);
}
.message-input input {
    flex: 1;
    padding: 12px;
    border-radius: 25px;
    border: none;
    outline: none;
    background: rgba(255,255,255,0.15);
    color: white;
    font-size: 0.95rem;
}
.message-input input::placeholder { color: rgba(255,255,255,0.6); }
.message-input button {
    padding: 12px 20px;
    background: rgba(0, 150, 255, 0.3);
    border: none;
    color: white;
    border-radius: 25px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 0.95rem;
    font-weight: 600;
}
.message-input button:hover { background: rgba(0, 150, 255, 0.5); }

/* ONLINE USERS */
.online-users-box {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    padding: 8px;
    color: white;
    font-size: 0.85rem;
    max-height: 120px;
    overflow-y: auto;
}
.online-users-box ul { list-style: none; margin: 5px 0 0; padding: 0; }
.online-users-box li { padding: 2px 0; }

/* Typing indicator */
#typing-indicator {
    display: none;
    color: white;
    font-style: italic;
    margin: 5px 5px;
    font-size: 0.85rem;
}

/* Divider */
hr {
  border: none;
  height: 2px;
  background: linear-gradient(to right, transparent, #ffffff, transparent);
  margin: 10px 0;
}

/* Responsive tweaks */
@media (max-width: 768px) {
    .chat-container {
        width: 98%;
        height: 92vh;
        padding: 15px;
    }
}
</style>

<body>
<!-- Main Chat -->
<main class="chat-container">
    <div class="chat-header">
        <h2 id="roomName"></h2>
        <div id="online-users" class="online-users-box">
            <strong>Online: </strong> <span id="online-count">0</span>
            <ul id="online-list"></ul>
            <div id="typing-indicator"></div>
        </div>
        <button id="leaveChat">Leave</button>
    </div>

    <div id="messages" class="messages"></div>


    <div class="message-input">
        <input type="text" id="messageBox" placeholder="Type your message...">
        <button id="sendBtn">Send</button>
    </div>
</main>

<script>
const BACKEND_URL = " "; // your baackend link here.

// Check login
const username = localStorage.getItem("username");
if (!username) window.location.href = "app.html";

// Get room
const params = new URLSearchParams(window.location.search);
const room = params.get("room");
if (!room) window.location.href = "app.html";

// Room names
const roomDisplayNames = {
    "General": `<strong> General Chat </strong><img src="assets/main.png" style="width:1.2em; vertical-align:middle;">`,
    "gaming": `<strong> Gaming Lounge </strong><img src="assets/video_game.png" style="width:1.2em; vertical-align:middle;">`,
    "study": `<strong> Study Room </strong><img src="assets/books.png" style="width:1.2em; vertical-align:middle;">`,
    "travel": `<strong> Travel Buddies </strong><img src="assets/earth_americas.png" style="width:1.2em; vertical-align:middle;">`
};
document.getElementById("roomName").innerHTML =
    roomDisplayNames[room] || (room.charAt(0).toUpperCase() + room.slice(1));

// WebSocket
const ws = new WebSocket(`wss://${BACKEND_URL.replace(/^https?:\/\//, '')}`);
let typingUsers = new Set();
let typingTimeout;

ws.onopen = () => {
    ws.send(JSON.stringify({ type: "join", room: room, user: username }));
};

ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === "history") {
        document.getElementById("messages").innerHTML = "";
        msg.data.forEach(m => addMessage(m.user, m.message, m.time));
    }
    if (msg.type === "message") addMessage(msg.data.user, msg.data.message, msg.data.time);
    if (msg.type === "users") document.getElementById("online-count").textContent = msg.data.length || 0;
    if (msg.type === "typing") { typingUsers.add(msg.user); updateTypingIndicator(); }
    if (msg.type === "stop_typing") { typingUsers.delete(msg.user); updateTypingIndicator(); }
};

// Error handling
function showServerError() {
    const messagesDiv = document.getElementById("messages");
    if (document.getElementById("server-error")) return; 
    const errorDiv = document.createElement("div");
    errorDiv.id = "server-error";
    errorDiv.style.color = "white";
    errorDiv.style.fontWeight = "bold";
    errorDiv.style.textAlign = "center";
    errorDiv.style.margin = "10px";
    errorDiv.textContent = "Server is turned off. Please contact the developer! ðŸ§ª";
    messagesDiv.appendChild(errorDiv);
    errorDiv.scrollIntoView();
}
ws.onerror = () => showServerError();
ws.onclose = () => showServerError();

// Send message
document.getElementById("sendBtn").addEventListener("click", sendMessage);
document.getElementById("messageBox").addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
});
document.getElementById("messageBox").addEventListener("input", () => {
    ws.send(JSON.stringify({ type: "typing", room, user: username }));
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        ws.send(JSON.stringify({ type: "stop_typing", room, user: username }));
    }, 1500);
});

function sendMessage() {
    const message = document.getElementById("messageBox").value.trim();
    if (!message) return;
    fetch(`${BACKEND_URL}/chat/${room}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user: username, message })
    }).catch(() => showServerError());
    document.getElementById("messageBox").value = "";
    ws.send(JSON.stringify({ type: "stop_typing", room, user: username }));
}

// Add message
function addMessage(user, message) {
    const div = document.createElement("div");
    div.classList.add("message");
    div.innerHTML = `<strong>${user}:</strong> ${message}`;
    document.getElementById("messages").appendChild(div);
    div.scrollIntoView();
}

// Typing indicator
function updateTypingIndicator() {
    const indicator = document.getElementById("typing-indicator");
    if (typingUsers.size > 0) {
        indicator.innerHTML = `<img src="assets/favicon2.png" style="width:1.2em; vertical-align:middle;"> ` 
            + Array.from(typingUsers).join(", ") 
            + ` is typing<span class='dots'><span>.</span><span>.</span><span>.</span></span>`;
        indicator.style.display = "block";
    } else {
        indicator.style.display = "none";
    }
}

// Leave chat
document.getElementById("leaveChat").addEventListener("click", () => {
    window.location.href = "app.html";
});
</script>

<style>
/* Typing dots animation */
.dots span { animation: blink 1.5s infinite; opacity: 0; }
.dots span:nth-child(1) { animation-delay: 0s; }
.dots span:nth-child(2) { animation-delay: 0.3s; }
.dots span:nth-child(3) { animation-delay: 0.6s; }

@keyframes blink {
    0%, 20% { opacity: 0; }
    50% { opacity: 1; }
    100% { opacity: 0; }
}
</style>
</body>
</html>
